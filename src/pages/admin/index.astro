---
export const prerender = false;

import '../../styles/global.css';
import { db } from '@lib/db';
import { products } from '@lib/db/schema';
import { isAdminAuthenticated, createSessionCookie } from '@lib/admin-auth';

const request = Astro.request;
const auth = isAdminAuthenticated(request);

if (auth === false) {
  return new Response('Unauthorized', {
    status: 401,
    headers: { 'WWW-Authenticate': 'Basic realm="Admin"' },
  });
}

if (auth && typeof auth === 'object' && auth.setCookie) {
  const { name, value, options } = createSessionCookie();
  Astro.response.headers.set('Set-Cookie', `${name}=${value}; ${options}`);
}

const productRows = await db.select({
  id: products.id,
  name: products.name,
  slug: products.slug,
  price: products.price,
  regularPrice: products.regularPrice,
  salePrice: products.salePrice,
  onSale: products.onSale,
  stockStatus: products.stockStatus,
  stockQuantity: products.stockQuantity,
}).from(products).orderBy(products.name);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="robots" content="noindex" />
    <title>Admin</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  </head>
  <body class="bg-gray-100 min-h-screen px-2 py-6 sm:p-6 font-sans">
    <div class="max-w-[1400px] mx-auto">
      <header class="mb-6 flex items-center justify-between px-2 sm:px-0">
        <a href="/" class="flex items-center">
          <img src="/hell-grey.png" alt="Hell" class="w-[100px] h-auto object-contain" />
        </a>
        <a href="/" class="text-sm text-gray-600 hover:text-gray-900">← Back to site</a>
      </header>

      {/* Mobile: header + list */}
      <div class="md:hidden">
        <div class="flex items-center justify-between gap-2 px-3 py-2 bg-gray-50 border border-b-0 border-gray-200 rounded-t-lg">
          <div class="flex items-center gap-2">
            <input type="checkbox" class="admin-select-all rounded border-gray-300" aria-label="Select all products" />
            <span class="text-xs font-medium text-gray-600">Product</span>
          </div>
          <div class="relative" id="admin-actions-wrapper-mobile">
            <button type="button" class="admin-actions-btn-mobile px-2 py-1 text-sm border border-gray-300 rounded bg-white hover:bg-gray-50 text-gray-700" aria-haspopup="true" aria-expanded="false">Actions ▾</button>
            <div id="admin-actions-menu-mobile" class="hidden absolute right-0 top-full mt-1 w-40 bg-white border border-gray-200 rounded shadow-lg py-1 z-10">
              <button type="button" class="admin-bulk-edit px-3 py-2 w-full text-left text-sm text-gray-700 hover:bg-gray-100">Edit</button>
              <button type="button" class="admin-bulk-delete px-3 py-2 w-full text-left text-sm text-red-600 hover:bg-red-50">Delete</button>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-b-lg border border-gray-200 divide-y divide-gray-100">
        {productRows.map((row) => (
          <div
            class="flex items-center gap-3 p-3 hover:bg-gray-50/50 admin-mobile-row"
            data-product-id={row.id}
            data-name={row.name ?? ''}
            data-slug={row.slug ?? ''}
            data-price={row.price ?? ''}
            data-regular-price={row.regularPrice ?? ''}
            data-sale-price={row.salePrice ?? ''}
            data-on-sale={row.onSale ?? false}
            data-stock-status={row.stockStatus ?? 'IN_STOCK'}
            data-stock-quantity={row.stockQuantity ?? ''}
          >
            <label class="flex flex-1 min-w-0 items-center gap-2 cursor-pointer">
              <input type="checkbox" class="admin-row-select rounded border-gray-300" value={String(row.id)} aria-label="Select product" />
              <span class="truncate text-sm text-gray-800">{row.name ?? 'Untitled'}</span>
            </label>
            <button type="button" class="admin-edit-btn shrink-0 px-3 py-1.5 text-sm bg-gray-800 text-white rounded hover:bg-gray-700" data-product-id={row.id}>Edit</button>
          </div>
        ))}
        </div>
      </div>

      {/* Desktop table */}
      <div class="hidden md:block bg-white rounded-lg border border-gray-200 overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="border-b border-gray-200 bg-gray-50">
              <th class="p-2 w-10">
                <input type="checkbox" class="admin-select-all rounded border-gray-300" aria-label="Select all products" />
              </th>
              <th class="p-2 text-xs font-medium text-gray-600">Product</th>
              <th class="p-2 text-xs font-medium text-gray-600">Slug</th>
              <th class="p-2 text-xs font-medium text-gray-600">Price</th>
              <th class="p-2 text-xs font-medium text-gray-600">Regular</th>
              <th class="p-2 text-xs font-medium text-gray-600">Sale</th>
              <th class="p-2 text-xs font-medium text-gray-600">On sale</th>
              <th class="p-2 text-xs font-medium text-gray-600">Stock</th>
              <th class="p-2 text-xs font-medium text-gray-600">Qty</th>
              <th class="p-2 text-xs font-medium text-gray-600 w-40">
                <div class="relative inline-block" id="admin-actions-wrapper">
                  <button type="button" id="admin-actions-btn" class="px-2 py-1 text-sm border border-gray-300 rounded bg-white hover:bg-gray-50 text-gray-700" aria-haspopup="true" aria-expanded="false">Actions ▾</button>
                  <div id="admin-actions-menu" class="hidden absolute right-0 top-full mt-1 w-40 bg-white border border-gray-200 rounded shadow-lg py-1 z-10">
                    <button type="button" class="admin-bulk-edit w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-100">Edit</button>
                    <button type="button" class="admin-bulk-delete w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50">Delete</button>
                  </div>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            {productRows.map((row) => (
              <tr class="border-b border-gray-100 hover:bg-gray-50/50 admin-desktop-row" data-product-id={row.id}>
                <td class="p-2">
                  <input type="checkbox" class="admin-row-select rounded border-gray-300" value={String(row.id)} aria-label="Select product" />
                </td>
                <td class="p-2"><input name="name" value={row.name ?? ''} class="w-full min-w-[120px] px-2 py-1 text-sm border border-gray-200 rounded" /></td>
                <td class="p-2"><input name="slug" value={row.slug ?? ''} class="w-full min-w-[120px] px-2 py-1 text-sm border border-gray-200 rounded" /></td>
                <td class="p-2"><input name="price" value={row.price ?? ''} type="text" class="w-20 px-2 py-1 text-sm border border-gray-200 rounded" /></td>
                <td class="p-2"><input name="regularPrice" value={row.regularPrice ?? ''} type="text" class="w-20 px-2 py-1 text-sm border border-gray-200 rounded" /></td>
                <td class="p-2"><input name="salePrice" value={row.salePrice ?? ''} type="text" class="w-20 px-2 py-1 text-sm border border-gray-200 rounded" /></td>
                <td class="p-2">
                  <select name="onSale" class="px-2 py-1 text-sm border border-gray-200 rounded">
                    <option value="false" selected={!row.onSale}>No</option>
                    <option value="true" selected={row.onSale ?? false}>Yes</option>
                  </select>
                </td>
                <td class="p-2">
                  <select name="stockStatus" class="px-2 py-1 text-sm border border-gray-200 rounded">
                    <option value="IN_STOCK" selected={row.stockStatus === 'IN_STOCK'}>In stock</option>
                    <option value="OUT_OF_STOCK" selected={row.stockStatus === 'OUT_OF_STOCK'}>Out of stock</option>
                    <option value="ON_BACKORDER" selected={row.stockStatus === 'ON_BACKORDER'}>Backorder</option>
                  </select>
                </td>
                <td class="p-2"><input name="stockQuantity" value={row.stockQuantity ?? ''} type="number" min="0" class="w-16 px-2 py-1 text-sm border border-gray-200 rounded" /></td>
                <td class="p-2">
                  <div class="flex flex-nowrap items-center gap-2">
                    <button type="button" class="edit-sizes-btn whitespace-nowrap px-2 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 text-gray-700" data-product-id={row.id} data-product-name={row.name ?? ''}>Edit sizes</button>
                    <button type="button" class="save-row px-2 py-1 text-sm bg-gray-800 text-white rounded hover:bg-gray-700">Save</button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {productRows.length === 0 && <p class="text-gray-500 py-8 text-center">No products.</p>}

      {/* Edit modal (mobile + desktop for sizes) */}
      <div id="admin-edit-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <div class="absolute inset-0 bg-black/50" id="admin-edit-modal-backdrop"></div>
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[calc(100%-1rem)] max-w-md max-h-[90vh] overflow-y-auto bg-white rounded-lg shadow-xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800">Edit product</h2>
            <button type="button" id="admin-edit-modal-close" class="p-2 text-gray-500 hover:text-gray-800" aria-label="Close">✕</button>
          </div>
          <form id="admin-edit-form" class="space-y-3">
            <input type="hidden" name="id" id="admin-edit-id" />
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Name</label>
              <input name="name" id="admin-edit-name" class="w-full px-2 py-1.5 text-sm border border-gray-200 rounded" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Slug</label>
              <input name="slug" id="admin-edit-slug" class="w-full px-2 py-1.5 text-sm border border-gray-200 rounded" />
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Price</label>
                <input name="price" id="admin-edit-price" type="text" class="w-full px-2 py-1.5 text-sm border border-gray-200 rounded" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Regular</label>
                <input name="regularPrice" id="admin-edit-regularPrice" type="text" class="w-full px-2 py-1.5 text-sm border border-gray-200 rounded" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Sale</label>
                <input name="salePrice" id="admin-edit-salePrice" type="text" class="w-full px-2 py-1.5 text-sm border border-gray-200 rounded" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">On sale</label>
                <select name="onSale" id="admin-edit-onSale" class="w-full px-2 py-1.5 text-sm border border-gray-200 rounded">
                  <option value="false">No</option>
                  <option value="true">Yes</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Stock</label>
                <select name="stockStatus" id="admin-edit-stockStatus" class="w-full px-2 py-1.5 text-sm border border-gray-200 rounded">
                  <option value="IN_STOCK">In stock</option>
                  <option value="OUT_OF_STOCK">Out of stock</option>
                  <option value="ON_BACKORDER">Backorder</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Qty</label>
                <input name="stockQuantity" id="admin-edit-stockQuantity" type="number" min="0" class="w-full px-2 py-1.5 text-sm border border-gray-200 rounded" />
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Size quantities</label>
              <div id="admin-edit-sizes" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded p-2 bg-gray-50"></div>
            </div>
            <div class="flex gap-2 pt-2">
              <button type="button" id="admin-edit-modal-cancel" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Cancel</button>
              <button type="submit" id="admin-edit-save" class="flex-1 px-3 py-2 text-sm bg-gray-800 text-white rounded hover:bg-gray-700">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script is:inline>
      (function selectAllAndActions() {
        var selectAllEls = document.querySelectorAll('.admin-select-all');
        var actionsBtns = document.querySelectorAll('#admin-actions-btn, .admin-actions-btn-mobile');
        var actionsMenus = document.querySelectorAll('#admin-actions-menu, #admin-actions-menu-mobile');

        function getRowCheckboxes() {
          return document.querySelectorAll('.admin-row-select');
        }

        function getCheckedIds() {
          var ids = [];
          getRowCheckboxes().forEach(function(cb) {
            if (cb.checked && cb.value) ids.push(cb.value);
          });
          return Array.from(new Set(ids));
        }

        function updateSelectAllState() {
          var all = getRowCheckboxes();
          var checked = document.querySelectorAll('.admin-row-select:checked');
          var allChecked = all.length > 0 && checked.length === all.length;
          var someChecked = checked.length > 0 && checked.length < all.length;
          selectAllEls.forEach(function(el) {
            el.checked = allChecked;
            el.indeterminate = someChecked;
          });
        }

        selectAllEls.forEach(function(selectAll) {
          selectAll.addEventListener('change', function() {
            getRowCheckboxes().forEach(function(cb) {
              cb.checked = selectAll.checked;
            });
            updateSelectAllState();
          });
        });

        document.querySelectorAll('.admin-row-select').forEach(function(cb) {
          cb.addEventListener('change', updateSelectAllState);
        });

        function setupDropdown(btn, menu) {
          if (!btn || !menu) return;
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            var open = !menu.classList.contains('hidden');
            actionsMenus.forEach(function(m) { m.classList.add('hidden'); });
            actionsBtns.forEach(function(b) { b.setAttribute('aria-expanded', 'false'); });
            if (!open) {
              menu.classList.remove('hidden');
              btn.setAttribute('aria-expanded', 'true');
            }
          });
        }
        var desktopBtn = document.getElementById('admin-actions-btn');
        var desktopMenu = document.getElementById('admin-actions-menu');
        var mobileBtn = document.querySelector('.admin-actions-btn-mobile');
        var mobileMenu = document.getElementById('admin-actions-menu-mobile');
        setupDropdown(desktopBtn, desktopMenu);
        setupDropdown(mobileBtn, mobileMenu);

        document.addEventListener('click', function() {
          actionsMenus.forEach(function(m) { m.classList.add('hidden'); });
          actionsBtns.forEach(function(b) { b.setAttribute('aria-expanded', 'false'); });
        });

        function closeAllMenus() {
          actionsMenus.forEach(function(m) { m.classList.add('hidden'); });
          actionsBtns.forEach(function(b) { b.setAttribute('aria-expanded', 'false'); });
        }

        document.querySelectorAll('.admin-bulk-edit').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var ids = getCheckedIds();
            if (ids.length === 0) {
              alert('Select at least one product.');
              return;
            }
            var firstRow = document.querySelector('tr.admin-desktop-row[data-product-id="' + ids[0] + '"]') || document.querySelector('.admin-mobile-row[data-product-id="' + ids[0] + '"]');
            var editBtn = firstRow && firstRow.querySelector('.edit-sizes-btn, .admin-edit-btn');
            if (editBtn) editBtn.click();
            closeAllMenus();
          });
        });

        document.querySelectorAll('.admin-bulk-delete').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            var ids = getCheckedIds();
            if (ids.length === 0) {
              alert('Select at least one product.');
              return;
            }
            if (!confirm('Delete ' + ids.length + ' product(s)? This cannot be undone.')) return;
            closeAllMenus();
            var ok = true;
            for (var i = 0; i < ids.length; i++) {
              var res = await fetch('/api/admin/product/' + ids[i], {
                method: 'DELETE',
                credentials: 'include',
              });
              if (!res.ok) ok = false;
            }
            if (ok) window.location.reload();
            else alert('Some products could not be deleted.');
          });
        });
      })();

      document.querySelectorAll('.save-row').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const tr = btn.closest('tr');
          if (!tr) return;
          const id = tr.dataset.productId;
          const get = (name) => tr.querySelector(`[name="${name}"]`);
          const getVal = (name) => {
            const el = get(name);
            if (!el) return undefined;
            if (el.tagName === 'SELECT') return el.value;
            return el.value;
          };
          const payload = {
            name: getVal('name'),
            slug: getVal('slug'),
            price: getVal('price') || null,
            regularPrice: getVal('regularPrice') || null,
            salePrice: getVal('salePrice') || null,
            onSale: getVal('onSale') === 'true',
            stockStatus: getVal('stockStatus'),
            stockQuantity: getVal('stockQuantity') ? parseInt(getVal('stockQuantity'), 10) : null,
          };
          btn.textContent = '…';
          btn.disabled = true;
          try {
            const res = await fetch(`/api/admin/product/${id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload),
            });
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              alert(err.error || `Save failed: ${res.status}`);
            }
          } catch (e) {
            alert('Network error');
          } finally {
            btn.textContent = 'Save';
            btn.disabled = false;
          }
        });
      });

      (function mobileEditModal() {
        const modal = document.getElementById('admin-edit-modal');
        const form = document.getElementById('admin-edit-form');
        const closeBtn = document.getElementById('admin-edit-modal-close');
        const cancelBtn = document.getElementById('admin-edit-modal-cancel');
        const backdrop = document.getElementById('admin-edit-modal-backdrop');
        const saveBtn = document.getElementById('admin-edit-save');
        if (!modal || !form || !closeBtn || !cancelBtn || !backdrop || !saveBtn) return;

        function openModal(row) {
          const id = row.dataset.productId;
          document.getElementById('admin-edit-id').value = id;
          document.getElementById('admin-edit-name').value = row.dataset.name ?? '';
          document.getElementById('admin-edit-slug').value = row.dataset.slug ?? '';
          document.getElementById('admin-edit-price').value = row.dataset.price ?? '';
          document.getElementById('admin-edit-regularPrice').value = row.dataset.regularPrice ?? '';
          document.getElementById('admin-edit-salePrice').value = row.dataset.salePrice ?? '';
          document.getElementById('admin-edit-onSale').value = row.dataset.onSale === 'true' ? 'true' : 'false';
          document.getElementById('admin-edit-stockStatus').value = row.dataset.stockStatus ?? 'IN_STOCK';
          document.getElementById('admin-edit-stockQuantity').value = row.dataset.stockQuantity ?? '';
          var sizesEl = document.getElementById('admin-edit-sizes');
          if (sizesEl) {
            sizesEl.innerHTML = '<span class="text-xs text-gray-500">Loading sizes…</span>';
            fetch('/api/admin/product/' + id + '/sizes', { credentials: 'include' })
              .then(function(r) { return r.json(); })
              .then(function(data) {
                sizesEl.innerHTML = '';
                if (data.sizes && data.sizes.length) {
                  data.sizes.forEach(function(s) {
                    var div = document.createElement('div');
                    div.className = 'flex items-center gap-2';
                    var label = document.createElement('span');
                    label.className = 'text-sm w-16 shrink-0';
                    label.textContent = s.size;
                    var input = document.createElement('input');
                    input.type = 'number';
                    input.min = 0;
                    input.setAttribute('data-size', s.size);
                    input.value = s.quantity;
                    input.className = 'w-20 px-2 py-1 text-sm border border-gray-200 rounded';
                    div.appendChild(label);
                    div.appendChild(input);
                    sizesEl.appendChild(div);
                  });
                } else {
                  sizesEl.innerHTML = '<span class="text-xs text-gray-500">No sizes for this product.</span>';
                }
              })
              .catch(function() {
                sizesEl.innerHTML = '<span class="text-xs text-red-500">Failed to load sizes.</span>';
              });
          }
          modal.classList.remove('hidden');
          modal.setAttribute('aria-hidden', 'false');
        }

        function closeModal() {
          modal.classList.add('hidden');
          modal.setAttribute('aria-hidden', 'true');
        }

        function openModalFromDesktopRow(tr) {
          if (!tr) return;
          const id = tr.dataset.productId;
          const getVal = (name) => {
            const el = tr.querySelector('[name="' + name + '"]');
            if (!el) return '';
            return el.tagName === 'SELECT' ? el.value : el.value;
          };
          document.getElementById('admin-edit-id').value = id;
          document.getElementById('admin-edit-name').value = getVal('name');
          document.getElementById('admin-edit-slug').value = getVal('slug');
          document.getElementById('admin-edit-price').value = getVal('price');
          document.getElementById('admin-edit-regularPrice').value = getVal('regularPrice');
          document.getElementById('admin-edit-salePrice').value = getVal('salePrice');
          document.getElementById('admin-edit-onSale').value = getVal('onSale');
          document.getElementById('admin-edit-stockStatus').value = getVal('stockStatus');
          document.getElementById('admin-edit-stockQuantity').value = getVal('stockQuantity');
          var sizesEl = document.getElementById('admin-edit-sizes');
          if (sizesEl) {
            sizesEl.innerHTML = '<span class="text-xs text-gray-500">Loading sizes…</span>';
            fetch('/api/admin/product/' + id + '/sizes', { credentials: 'include' })
              .then(function(r) { return r.json(); })
              .then(function(data) {
                sizesEl.innerHTML = '';
                if (data.sizes && data.sizes.length) {
                  data.sizes.forEach(function(s) {
                    var div = document.createElement('div');
                    div.className = 'flex items-center gap-2';
                    var label = document.createElement('span');
                    label.className = 'text-sm w-16 shrink-0';
                    label.textContent = s.size;
                    var input = document.createElement('input');
                    input.type = 'number';
                    input.min = 0;
                    input.setAttribute('data-size', s.size);
                    input.value = s.quantity;
                    input.className = 'w-20 px-2 py-1 text-sm border border-gray-200 rounded';
                    div.appendChild(label);
                    div.appendChild(input);
                    sizesEl.appendChild(div);
                  });
                } else {
                  sizesEl.innerHTML = '<span class="text-xs text-gray-500">No sizes. Add a Size attribute to this product to manage per-size stock.</span>';
                }
              })
              .catch(function() {
                sizesEl.innerHTML = '<span class="text-xs text-red-500">Failed to load sizes.</span>';
              });
          }
          modal.classList.remove('hidden');
          modal.setAttribute('aria-hidden', 'false');
        }

        document.querySelectorAll('.admin-edit-btn').forEach((btn) => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const row = btn.closest('.admin-mobile-row');
            if (row) openModal(row);
          });
        });

        document.querySelectorAll('.edit-sizes-btn').forEach((btn) => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const tr = btn.closest('tr');
            if (tr) openModalFromDesktopRow(tr);
          });
        });

        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        backdrop.addEventListener('click', closeModal);

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const id = document.getElementById('admin-edit-id').value;
          var sizeInputs = document.querySelectorAll('#admin-edit-sizes input[data-size]');
          var sizeInventory = [];
          sizeInputs.forEach(function(input) {
            var s = input.getAttribute('data-size');
            if (s) sizeInventory.push({ size: s, quantity: parseInt(input.value, 10) || 0 });
          });
          const payload = {
            name: document.getElementById('admin-edit-name').value,
            slug: document.getElementById('admin-edit-slug').value,
            price: document.getElementById('admin-edit-price').value || null,
            regularPrice: document.getElementById('admin-edit-regularPrice').value || null,
            salePrice: document.getElementById('admin-edit-salePrice').value || null,
            onSale: document.getElementById('admin-edit-onSale').value === 'true',
            stockStatus: document.getElementById('admin-edit-stockStatus').value,
            stockQuantity: document.getElementById('admin-edit-stockQuantity').value ? parseInt(document.getElementById('admin-edit-stockQuantity').value, 10) : null,
            sizeInventory: sizeInventory.length ? sizeInventory : undefined,
          };
          saveBtn.textContent = '…';
          saveBtn.disabled = true;
          try {
            const res = await fetch('/api/admin/product/' + id, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload),
            });
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              alert(err.error || 'Save failed: ' + res.status);
            } else {
              const mobileRow = document.querySelector('.admin-mobile-row[data-product-id="' + id + '"]');
              if (mobileRow) {
                mobileRow.dataset.name = payload.name;
                mobileRow.dataset.slug = payload.slug;
                mobileRow.dataset.price = payload.price ?? '';
                mobileRow.dataset.regularPrice = payload.regularPrice ?? '';
                mobileRow.dataset.salePrice = payload.salePrice ?? '';
                mobileRow.dataset.onSale = payload.onSale;
                mobileRow.dataset.stockStatus = payload.stockStatus;
                mobileRow.dataset.stockQuantity = String(payload.stockQuantity ?? '');
                const nameEl = mobileRow.querySelector('label span');
                if (nameEl) nameEl.textContent = payload.name || 'Untitled';
              }
              const desktopRow = document.querySelector('tr[data-product-id="' + id + '"]');
              if (desktopRow) {
                var setVal = function(name, val) {
                  var el = desktopRow.querySelector('[name="' + name + '"]');
                  if (el) el.value = val ?? '';
                };
                setVal('name', payload.name);
                setVal('slug', payload.slug);
                setVal('price', payload.price);
                setVal('regularPrice', payload.regularPrice);
                setVal('salePrice', payload.salePrice);
                setVal('onSale', payload.onSale);
                setVal('stockStatus', payload.stockStatus);
                setVal('stockQuantity', payload.stockQuantity);
              }
              closeModal();
            }
          } catch (err) {
            alert('Network error');
          } finally {
            saveBtn.textContent = 'Save';
            saveBtn.disabled = false;
          }
        });
      })();
    </script>
  </body>
</html>
