---
/**
 * Products Listing Page
 */
import Layout from '@layouts/Layout.astro';
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import { graphqlRequest } from '@lib/wpgraphql';
import { PRODUCTS_QUERY, CATEGORIES_QUERY, type GetProductsResponse, type GetCategoriesResponse } from '@lib/queries';
import { stripPriceHtml } from '@lib/wpgraphql';
import type { Product, ProductCategory } from '@lib/types';

let products: Product[] = [];
let categories: ProductCategory[] = [];

try {
  const [productsData, categoriesData] = await Promise.all([
    graphqlRequest<GetProductsResponse>({
      query: PRODUCTS_QUERY,
      variables: {
        first: 100,
      },
    }),
    graphqlRequest<GetCategoriesResponse>({
      query: CATEGORIES_QUERY,
      variables: {
        first: 50,
      },
    }),
  ]);

  products = productsData.products.nodes;
  categories = categoriesData.productCategories.nodes;
} catch (error) {
  console.error('Error fetching data:', error);
}
---

<Layout title="All Products" hideHeader={true}>
  <main class="min-h-screen bg-white">
    <Header />

    <!-- Main Content -->
    <div class="max-w-[1920px] mx-auto flex flex-col gap-0">
      <div id="shop-navigation" class="w-full px-8 py-4 flex items-center justify-between relative">
        <h1 class="text-md text-black uppercase">SHOP</h1>
        {categories.length > 0 && (
          <ul class="flex items-center gap-6 absolute left-1/2 transform -translate-x-1/2">
            {categories.map((category) => (
              <li>
                <a
                  href={`/products?category=${category.slug}`}
                  class="text-md text-black uppercase hover:opacity-70 transition-opacity"
                >
                  {category.name}
                </a>
              </li>
            ))}
          </ul>
        )}
        <button class="text-md text-black uppercase hover:opacity-70 transition-opacity">
          FILTERS
        </button>
      </div>

      {products.length === 0 ? (
        <div class="text-center py-12">
          <p class="text-gray-500">No products found.</p>
          <p class="text-sm text-gray-400 mt-2">
            Make sure WORDPRESS_API_URL is configured and your WordPress site has WPGraphQL + WooGraphQL installed.
          </p>
        </div>
      ) : (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-0 product-grid">
          {products.map((product) => {
            // Format price: extract numeric value and format as USD XX.XX
            let formattedPrice: string | null = null;
            if (product.price) {
              const cleanPrice = stripPriceHtml(product.price);
              // Extract numeric value (handles various formats like $50.00, 50.00, Â£50, etc.)
              const numericMatch = cleanPrice.match(/(\d+\.?\d*)/);
              if (numericMatch) {
                const numericValue = parseFloat(numericMatch[1]);
                formattedPrice = `USD ${numericValue.toFixed(2)}`;
              }
            }
            
            return (
              <a
                href={`/products/${product.slug}`}
                class="group"
              >
                {/* Product Image - Square with light gray background */}
                <div class="w-full aspect-square bg-gray-100 mb-2 flex items-center justify-center overflow-hidden">
                  {product.image ? (
                    <img
                      src={product.image.sourceUrl}
                      alt={product.image.altText || product.name}
                      class="w-full h-full object-contain group-hover:opacity-90 transition-opacity"
                    />
                  ) : (
                    <span class="text-gray-400 text-sm">No image</span>
                  )}
                </div>
                
                {/* Product Info */}
                <div class="space-y-1 text-center">
                  <h2 class="text-base font-bold uppercase text-[#00cd00] group-hover:opacity-70 transition-opacity product-title">
                    {product.name}
                  </h2>
                  
                  {formattedPrice && (
                    <p class="text-sm text-black font-medium mt-2">
                      {formattedPrice}
                    </p>
                  )}
                </div>
              </a>
            );
          })}
        </div>
      )}
    </div>

    <Footer />
  </main>
</Layout>

<style>
  /* Custom scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: #f9fafb;
  }
  
  ::-webkit-scrollbar-thumb {
    background: #e5e7eb;
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: #d1d5db;
  }
  
  /* Subtle black glow on text */
  h1, p, span {
    text-shadow: 0 0 2px rgba(0, 0, 0, 0.3), 0 0 4px rgba(0, 0, 0, 0.2);
  }
  
  /* Yellow-green glow on product titles */
  .product-title {
    text-shadow: 0 0 2px rgba(200, 255, 0, 0.8), 0 0 4px rgba(200, 255, 0, 0.6), 0 0 6px rgba(200, 255, 0, 0.4);
  }
  
  /* Grid divider lines */
  .product-grid {
    border-top: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .product-grid > a {
    border-right: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
    padding: 1rem;
  }
  
  /* Remove right border on last column */
  .product-grid > a:nth-child(3n) {
    border-right: none;
  }
  
  /* Remove bottom border on last row items */
  .product-grid > a:nth-last-child(-n+3) {
    border-bottom: none;
  }
  
  /* Responsive: Remove right border on 2-column layout */
  @media (min-width: 640px) and (max-width: 1023px) {
    .product-grid > a:nth-child(3n) {
      border-right: 1px solid #e5e7eb;
    }
    .product-grid > a:nth-child(2n) {
      border-right: none;
    }
    .product-grid > a:nth-last-child(-n+2) {
      border-bottom: none;
    }
  }
  
  /* Responsive: Remove all borders on single column */
  @media (max-width: 639px) {
    .product-grid > a {
      border-right: none;
      border-bottom: 1px solid #e5e7eb;
    }
    .product-grid > a:last-child {
      border-bottom: none;
    }
  }
</style>
