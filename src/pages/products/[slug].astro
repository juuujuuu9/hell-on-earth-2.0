---
/**
 * Product Detail Page
 * 
 * RULE-005: Every product page must have a getStaticPaths function
 */
import Layout from '@layouts/Layout.astro';
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import type { Product } from '@lib/types';
import CartButton from '@components/CartButton';
import { getAllProducts, getProductBySlug } from '@lib/db/queries';

interface Props {
  product: Product;
}

export async function getStaticPaths() {
  try {
    const products = await getAllProducts();
    return products.map((product) => ({
      params: { slug: product.slug },
      props: { product },
    }));
  } catch (error) {
    console.error('Error generating static paths:', error);
    // Return empty array if database is not set up yet
    return [];
  }
}

// Helper function to strip HTML from price strings
function stripPriceHtml(price: string): string {
  return price.replace(/<[^>]*>/g, '').trim();
}

// Helper function to format price as USD
function formatPrice(price: string | undefined): string {
  if (!price) return 'Price unavailable';
  const cleanPrice = stripPriceHtml(price);
  const numericMatch = cleanPrice.match(/(\d+\.?\d*)/);
  if (numericMatch) {
    const numericValue = parseFloat(numericMatch[1]);
    return `${numericValue.toFixed(2)} USD`;
  }
  return cleanPrice;
}

const { slug } = Astro.params;
const product = await getProductBySlug(slug || '');

if (!product) {
  return Astro.redirect('/404');
}

const formattedPrice = formatPrice(product.price);
const colorAttribute = product.attributes?.nodes.find(attr => attr.name.toLowerCase() === 'color');
const sizeAttribute = product.attributes?.nodes.find(attr => attr.name.toLowerCase() === 'size');
const features = product.attributes?.nodes.filter(attr => 
  attr.name.toLowerCase() !== 'color' && attr.name.toLowerCase() !== 'size'
) || [];

// Get all images for gallery
const allImages = product.galleryImages?.nodes || [];
const primaryImage = product.image;
const displayImages = primaryImage 
  ? [primaryImage, ...allImages.filter(img => img.sourceUrl !== primaryImage.sourceUrl)]
  : allImages;
const hasMultipleImages = displayImages.length > 1;
---

<Layout title={product.name} hideHeader={true}>
  <main class="min-h-screen bg-white">
    <Header />

    <!-- Product Content -->
    <div class="p-0">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-0 max-w-[1920px] mx-auto">
        <!-- Left Column: Product Image -->
        <div class="w-full lg:border-r lg:border-gray-200 py-0 pb-6 flex flex-col relative overflow-hidden">
          {displayImages.length > 0 ? (
            <div class="px-16 flex-1 flex flex-col">
              <div class="w-full aspect-square bg-white relative overflow-hidden group" style="min-height: 0;">
                <div id="image-slider" class="relative h-full flex" style={`width: ${displayImages.length * 100}%; transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1);`}>
                  {displayImages.map((img, index) => (
                    <div class="shrink-0 h-full relative bg-white flex items-center justify-center" style={`width: ${100 / displayImages.length}%;`}>
                      <img
                        data-image-index={index}
                        src={img.sourceUrl}
                        alt={img.altText || product.name}
                        class="w-full h-full object-contain"
                        style="display: block;"
                        loading={index === 0 ? "eager" : "lazy"}
                        width="800"
                        height="800"
                        decoding="async"
                      />
                    </div>
                  ))}
                </div>
                {hasMultipleImages && (
                  <>
                    <button
                      id="image-prev"
                      class="absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer z-10"
                      aria-label="Previous image"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-white">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                      </svg>
                    </button>
                    <button
                      id="image-next"
                      class="absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer z-10"
                      aria-label="Next image"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-white">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                      </svg>
                    </button>
                  </>
                )}
              </div>
              {hasMultipleImages && (
                <div class="flex w-full gap-2 mt-4">
                  {displayImages.map((img, index) => (
                    <button
                      data-dot-index={index}
                      class={`h-1 flex-1 transition-opacity ${
                        index === 0 ? 'bg-black' : 'bg-gray-300'
                      } hover:opacity-70 cursor-pointer`}
                      aria-label={`View image ${index + 1}`}
                    />
                  ))}
                </div>
              )}
            </div>
          ) : (
            <div class="w-full aspect-square bg-gray-100 flex items-center justify-center">
              <span class="text-gray-400">No image available</span>
            </div>
          )}

          <!-- Measurements Tray (Desktop Only) - Nested inside left column -->
          {product.measurements && (
            <div 
              id="measurements-tray"
              class="hidden lg:block absolute top-0 left-0 right-0 bottom-0 bg-white z-50 transform translate-x-full transition-transform duration-500 ease-in-out overflow-y-auto"
              style="will-change: transform;"
            >
              <div class="p-16 h-full flex flex-col">
                <!-- Close Button -->
                <button
                  id="measurements-close"
                  class="absolute top-8 right-8 w-10 h-10 flex items-center justify-center hover:bg-gray-100 transition-colors cursor-pointer"
                  aria-label="Close measurements"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>

                <!-- Measurements Content -->
                <div class="flex-1">
                  <h2 class="text-2xl font-bold uppercase tracking-wide mb-8">
                    <span class="text-black">■</span> MEASUREMENTS
                  </h2>
                  <div id="measurements-content" class="text-base leading-relaxed">
                    {/* Measurements will be rendered here */}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

        <!-- Right Column: Product Details -->
        <div class="flex flex-col py-0 pt-4">
          <!-- Breadcrumbs -->
          <nav class="text-sm text-gray-600 px-8 pb-8" aria-label="Breadcrumb">
            <ol class="flex items-center gap-2">
              <li>
                <a href="/" class="hover:text-gray-900 transition-colors">HOME</a>
              </li>
              {product.productCategories?.nodes && product.productCategories.nodes.length > 0 && (
                <>
                  <li class="text-gray-400">/</li>
                  <li>
                    <a 
                      href={`/products?category=${encodeURIComponent(product.productCategories.nodes[0].slug)}`}
                      class="hover:text-gray-900 transition-colors"
                    >
                      {product.productCategories.nodes[0].name.toUpperCase()}
                    </a>
                  </li>
                </>
              )}
              <li class="text-gray-400">/</li>
              <li class="text-gray-900 font-medium" aria-current="page">
                {product.name.toUpperCase()}
              </li>
            </ol>
          </nav>

          <!-- Product Identifier -->
          <div class="text-xl font-bold uppercase tracking-wide text-gray-700 pb-0 px-8">
            <!-- <span class="text-black">■</span> -->
             {product.name}
          </div>

          <!-- Price -->
          <div class="space-y-1 pt-4 px-8">
            <div class="text-base tracking-wide">{formattedPrice}</div>
            <div class="text-xs text-gray-500">VAT EXCLUDED / EXCL. SHIPPING</div>
          </div>

          <!-- Add to Cart Button -->
          <div class="pt-4 px-8 pb-4 min-h-[60px]" id="cart-button-wrapper">
            {product.stockStatus === 'IN_STOCK' ? (
              <>
                {/* Static fallback button - renders immediately, prevents flash */}
                <div id="cart-button-fallback" class="min-h-[52px]">
                  <button
                    id="cart-button-fallback-btn"
                    class="w-full px-6 py-4 bg-black text-white uppercase font-semibold hover:opacity-70 transition-opacity cursor-pointer"
                    data-stripe-url={product.stripeCheckoutUrl || ''}
                    data-product-id={product.id}
                  >
                    + ADD TO CART
                  </button>
                </div>
                {/* React component - replaces fallback when hydrated */}
                <div id="cart-button-react" style="display: none;">
                  <CartButton
                    client:load
                    productId={product.id}
                    productName={product.name}
                    stripeCheckoutUrl={product.stripeCheckoutUrl}
                  />
                </div>
              </>
            ) : (
              <div class="h-[52px]"></div>
            )}
          </div>

          <!-- Short Description -->
          {product.shortDescription ? (
            <div class="text-base leading-relaxed border-t border-gray-200 pt-6 px-8 pb-6">
              <div set:html={product.shortDescription} />
            </div>
          ) : null}

          <!-- Full Description -->
          {product.description ? (
            <div class="text-base leading-relaxed border-t border-gray-200 pt-6 px-8 pb-6">
              <div set:html={product.description} />
            </div>
          ) : null}

          <!-- Details and Materials Section -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 border-t border-gray-200 pt-6 px-8 pb-6">
            <!-- Details Column -->
            <div class="space-y-3">
              <div class="text-xs font-bold uppercase tracking-wide mb-4">
                <span class="text-black">■</span> DETAILS
              </div>
              {product.details ? (
                <div class="text-base leading-relaxed [&_ul]:list-disc [&_ul]:ml-6 [&_ul]:space-y-1 [&_li]:leading-relaxed">
                  <div set:html={product.details} />
                </div>
              ) : (
                <>
                  {colorAttribute && colorAttribute.options.length > 0 && (
                    <div class="text-base">
                      <span class="font-medium uppercase">COLOR:</span> {colorAttribute.options.join(', ').toUpperCase()}
                    </div>
                  )}
                  {product.measurements && (
                    <div class="text-base">
                      <button 
                        id="measurements-toggle"
                        class="uppercase underline hover:no-underline cursor-pointer"
                        aria-label="View measurements"
                      >
                        MEASUREMENTS
                      </button>
                    </div>
                  )}
                  {sizeAttribute && sizeAttribute.options.length > 0 && (
                    <div class="text-base">
                      <span class="font-medium uppercase">SIZE:</span> {sizeAttribute.options.join(', ').toUpperCase()}
                    </div>
                  )}
                </>
              )}
            </div>

            <!-- Materials Column -->
            <div class="space-y-3">
              <div class="text-xs font-bold uppercase tracking-wide mb-4">
                <span class="text-black">■</span> MATERIALS
              </div>
              <div class="text-base leading-relaxed [&_ul]:list-disc [&_ul]:ml-6 [&_ul]:space-y-1 [&_li]:leading-relaxed">
                {product.materials ? (
                  <div set:html={product.materials} />
                ) : (
                  <div>Product materials information available upon request.</div>
                )}
              </div>
            </div>
          </div>

          <!-- Product Features -->
          {(product.features || features.length > 0) && (
            <div class="space-y-3 border-t border-gray-200 pt-8 px-8 pb-8">
              <div class="text-xs font-bold uppercase tracking-wide mb-4">
                <span class="text-black">■</span> PRODUCT FEATURES
              </div>
              {product.features ? (
                <div class="text-base leading-relaxed [&_ul]:list-disc [&_ul]:ml-6 [&_ul]:space-y-1 [&_li]:leading-relaxed">
                  <div set:html={product.features} />
                </div>
              ) : (
                <ul class="space-y-2 text-base leading-relaxed">
                  {features.map((feature) => (
                    <li class="flex items-start">
                      <span class="mr-2 text-black">•</span>
                      <span>{feature.options.map(opt => `${feature.name.toLowerCase()} ${opt}`).join(', ')}</span>
                    </li>
                  ))}
                </ul>
              )}
            </div>
          )}
        </div>
      </div>
    </div>

    <!-- Border line before footer -->
    <div class="border-t border-gray-200 -mx-8"></div>

    <Footer />
  </main>
</Layout>

{hasMultipleImages && (
  <script define:vars={{ images: displayImages.map(img => ({ url: img.sourceUrl, alt: img.altText || product.name })) }}>
    (function() {
      const imageSlider = document.getElementById('image-slider');
      const dotButtons = document.querySelectorAll('[data-dot-index]');
      const prevButton = document.getElementById('image-prev');
      const nextButton = document.getElementById('image-next');
      let currentIndex = 0;
      let isTransitioning = false;

      if (!imageSlider || dotButtons.length === 0) return;

      function updateImage(index, direction = 'next') {
        if (isTransitioning || index === currentIndex) return;
        
        isTransitioning = true;
        const translatePercent = (index * 100) / images.length;
        imageSlider.style.transform = `translateX(-${translatePercent}%)`;

        // Update active indicator immediately
        dotButtons.forEach((btn, i) => {
          if (i === index) {
            btn.classList.remove('bg-gray-300');
            btn.classList.add('bg-black');
          } else {
            btn.classList.remove('bg-black');
            btn.classList.add('bg-gray-300');
          }
        });

        currentIndex = index;
        
        // Reset transition lock after animation completes
        setTimeout(() => {
          isTransitioning = false;
        }, 300);
      }

      // Handle dot navigation
      dotButtons.forEach((button, index) => {
        button.addEventListener('click', () => {
          const direction = index > currentIndex ? 'next' : 'prev';
          updateImage(index, direction);
        });
      });

      // Handle arrow navigation
      if (prevButton) {
        prevButton.addEventListener('click', () => {
          const newIndex = currentIndex === 0 ? images.length - 1 : currentIndex - 1;
          updateImage(newIndex, 'prev');
        });
      }

      if (nextButton) {
        nextButton.addEventListener('click', () => {
          const newIndex = currentIndex === images.length - 1 ? 0 : currentIndex + 1;
          updateImage(newIndex, 'next');
        });
      }
    })();
  </script>
)}

{product.measurements && (
  <script define:vars={{ measurementsData: product.measurements }}>
    (function() {
      const measurementsToggle = document.getElementById('measurements-toggle');
      const measurementsTray = document.getElementById('measurements-tray');
      const measurementsClose = document.getElementById('measurements-close');
      const measurementsContent = document.getElementById('measurements-content');
      
      if (!measurementsToggle || !measurementsTray || !measurementsClose || !measurementsContent) return;

      // Parse measurements data (could be JSON or HTML)
      function renderMeasurements(data) {
        try {
          // Try to parse as JSON first
          const parsed = JSON.parse(data);
          
          // If it's an array of measurement objects, render as table
          if (Array.isArray(parsed) && parsed.length > 0) {
            let html = '<div class="space-y-8">';
            
            parsed.forEach((measurementGroup, groupIndex) => {
              if (measurementGroup.sizes && Array.isArray(measurementGroup.sizes)) {
                const firstSize = measurementGroup.sizes[0];
                
                // Check if this is denim format (has waist, lowHip, lengths) or simple format (has measurements)
                const isDenimFormat = firstSize.waist && firstSize.lowHip && firstSize.lengths;
                
                if (isDenimFormat) {
                  // Denim format: complex table with waist, lowHip, and multiple lengths
                  html += '<div class="mb-8">';
                  if (measurementGroup.sizeRange) {
                    html += `<h3 class="text-lg font-bold uppercase mb-4">${measurementGroup.sizeRange}</h3>`;
                  }
                  html += '<div class="overflow-x-auto">';
                  html += '<table class="w-full border-collapse text-sm">';
                  html += '<thead><tr class="border-b-2 border-black">';
                  html += '<th class="text-left py-3 px-4 font-bold uppercase">Size</th>';
                  html += '<th class="text-left py-3 px-4 font-bold uppercase">Waist</th>';
                  html += '<th class="text-left py-3 px-4 font-bold uppercase">Low Hip</th>';
                  html += '<th class="text-left py-3 px-4 font-bold uppercase">32" Length</th>';
                  html += '<th class="text-left py-3 px-4 font-bold uppercase">30" Length</th>';
                  html += '<th class="text-left py-3 px-4 font-bold uppercase">34" Length</th>';
                  html += '</tr></thead><tbody>';
                  
                  measurementGroup.sizes.forEach(size => {
                    html += '<tr class="border-b border-gray-200">';
                    html += `<td class="py-3 px-4 font-medium">${size.size || ''}</td>`;
                    html += `<td class="py-3 px-4">${size.waist?.inch || ''} (${size.waist?.cm || ''}cm)</td>`;
                    html += `<td class="py-3 px-4">${size.lowHip?.inch || ''} (${size.lowHip?.cm || ''}cm)</td>`;
                    html += `<td class="py-3 px-4">${size.lengths?.['32"']?.inch || ''} (${size.lengths?.['32"']?.cm || ''}cm)</td>`;
                    html += `<td class="py-3 px-4">${size.lengths?.['30"']?.inch || ''} (${size.lengths?.['30"']?.cm || ''}cm)</td>`;
                    html += `<td class="py-3 px-4">${size.lengths?.['34"']?.inch || ''} (${size.lengths?.['34"']?.cm || ''}cm)</td>`;
                    html += '</tr>';
                  });
                  
                  html += '</tbody></table>';
                  html += '</div>';
                  html += '</div>';
                } else {
                  // Simple format: flat measurements object (tee shirts, jackets)
                  html += '<div class="overflow-x-auto">';
                  if (measurementGroup.sizeRange) {
                    html += `<h3 class="text-lg font-bold uppercase mb-4">${measurementGroup.sizeRange}</h3>`;
                  }
                  html += '<table class="w-full border-collapse text-sm">';
                  html += '<thead><tr class="border-b-2 border-black">';
                  
                  html += '<th class="text-left py-3 px-4 font-bold uppercase">Size</th>';
                  Object.keys(firstSize.measurements || {}).forEach(key => {
                    html += `<th class="text-left py-3 px-4 font-bold uppercase">${key}</th>`;
                  });
                  
                  html += '</tr></thead><tbody>';
                  
                  measurementGroup.sizes.forEach(size => {
                    html += '<tr class="border-b border-gray-200">';
                    html += `<td class="py-3 px-4 font-medium">${size.size || ''}</td>`;
                    Object.values(size.measurements || {}).forEach(value => {
                      html += `<td class="py-3 px-4">${value}</td>`;
                    });
                    html += '</tr>';
                  });
                  
                  html += '</tbody></table>';
                  html += '</div>';
                }
              }
            });
            
            html += '</div>';
            return html;
          }
        } catch (e) {
          // Not JSON, treat as HTML
        }
        
        // Fallback: render as HTML
        return data;
      }

      // Set initial content
      measurementsContent.innerHTML = renderMeasurements(measurementsData);

      // Open tray
      function openTray() {
        measurementsTray.classList.remove('translate-x-full');
        measurementsTray.classList.add('translate-x-0');
      }

      // Close tray
      function closeTray() {
        measurementsTray.classList.remove('translate-x-0');
        measurementsTray.classList.add('translate-x-full');
      }

      // Check if tray is open
      function isTrayOpen() {
        return !measurementsTray.classList.contains('translate-x-full');
      }

      // Event listeners
      measurementsToggle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (isTrayOpen()) {
          closeTray();
        } else {
          openTray();
        }
      });

      measurementsClose.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeTray();
      });

      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isTrayOpen()) {
          closeTray();
        }
      });

      // Close on click outside the tray
      document.addEventListener('click', (e) => {
        if (!isTrayOpen()) return;
        
        // If click is outside the tray, close it
        if (!measurementsTray.contains(e.target) && e.target !== measurementsToggle) {
          closeTray();
        }
      });

      // Prevent clicks inside the tray from closing it
      measurementsTray.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    })();
  </script>
)}

{/* Replace static button with React component when ready */}
{product.stockStatus === 'IN_STOCK' && (
  <script define:vars={{ stripeCheckoutUrl: product.stripeCheckoutUrl, productId: product.id }}>
    (function() {
      const fallback = document.getElementById('cart-button-fallback');
      const reactContainer = document.getElementById('cart-button-react');
      const fallbackBtn = document.getElementById('cart-button-fallback-btn');
      
      if (!fallback || !reactContainer || !fallbackBtn) return;
      
      // Attach click handler to fallback button
      fallbackBtn.addEventListener('click', async () => {
        if (stripeCheckoutUrl) {
          window.location.href = stripeCheckoutUrl;
          return;
        }
        
        try {
          const response = await fetch(`/api/stripe-checkout?productId=${productId}`);
          if (!response.ok) throw new Error('Failed to get checkout URL');
          const data = await response.json();
          if (data.checkoutUrl) {
            window.location.href = data.checkoutUrl;
          }
        } catch (err) {
          console.error('Error getting checkout URL:', err);
        }
      });
      
      // Check if React component has hydrated
      const checkReactReady = setInterval(() => {
        const reactButton = reactContainer.querySelector('button');
        if (reactButton && reactButton.offsetParent !== null) {
          // React component is ready, swap them
          fallback.style.display = 'none';
          reactContainer.style.display = 'block';
          clearInterval(checkReactReady);
        }
      }, 50);
      
      // Cleanup after 5 seconds - keep fallback if React never loads
      setTimeout(() => {
        clearInterval(checkReactReady);
      }, 5000);
    })();
  </script>
)}

